name: SpringBoot CI/CD for ECS (GitOps)

# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹œì‘
on:
  workflow_dispatch:
    inputs:
      project_name:
        type: string
        required: true
      container_port:
        type: string
        default: "8080"

env:
  # ğŸ’¡ AWS/ECR ì„¤ì • ë³€ìˆ˜ (ì‚¬ìš©ì í™˜ê²½ì— ë§ê²Œ ë³€ê²½ í•„ìš”)
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: 277679348386.dkr.ecr.ap-northeast-2.amazonaws.com/cat-demo-backend
  ECS_CLUSTER_NAME: arn:aws:ecs:ap-northeast-2:277679348386:cluster/cat-demo-cluster
  ECS_SERVICE_NAME: arn:aws:ecs:ap-northeast-2:277679348386:service/cat-demo-cluster/cat-demo-backend-service
  TASK_DEFINITION_PATH: your-task-definition.json # ECS íƒœìŠ¤í¬ ì •ì˜ íŒŒì¼ ê²½ë¡œ
  IMAGE_TAG: ${{ github.sha }} # ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì»¤ë°‹ SHA ì‚¬ìš©

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # í™˜ê²½ ë³€ìˆ˜ ë° Secrets ì„¤ì •
    environment: production 

    steps:
    
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (Checkout Code)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Java í™˜ê²½ ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 3. í…ŒìŠ¤íŠ¸ (Test)
      - name: Run Unit Tests
        run: ./gradlew test

      # ---------------------------
      # 4. ë³´ì•ˆ ì ê²€ (SAST by Snyk) ğŸ›¡ï¸
      # ---------------------------
      # Snyk Code: SAST ë¶„ì„ (ìì²´ ì½”ë“œ)
      - name: Snyk Code (SAST) Scan
        uses: snyk/actions/code@master
        with:
          args: --all-projects --sarif-output=snyk-code-report.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # Snyk Open Source: SCA ë¶„ì„ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì·¨ì•½ì )
      - name: Snyk Open Source (SCA) Scan
        uses: snyk/actions/maven@master
        with:
          args: --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        
      # ê²°ê³¼ ë³´ê³ ì„œë¥¼ GitHub Security Tabì— ì—…ë¡œë“œ 
      - name: Upload SARIF file to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code-report.sarif

      # ---------------------------
      # 5. ECR/ECS ì„¤ì • ë° ë°°í¬
      # ---------------------------

      # AWS ìê²© ì¦ëª… ì„¤ì • (IAM Role ë˜ëŠ” Secrets ì‚¬ìš©)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê·¸ ì§€ì • (Tag: latest, SHA)
      - name: Build, tag, and push image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # Spring Boot JAR ë¹Œë“œ
          ./gradlew bootJar
          
          # Dockerfileì€ JAR íŒŒì¼ê³¼ ë™ì¼ ë””ë ‰í† ë¦¬ì— ìˆë‹¤ê³  ê°€ì •
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # 6. ECS íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸ (Deploy)
      - name: Fill in the new image ID in the ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.TASK_DEFINITION_PATH }}
          container-name: your-container-name # íƒœìŠ¤í¬ ì •ì˜ íŒŒì¼ì˜ ì»¨í…Œì´ë„ˆ ì´ë¦„ (í•„ìˆ˜)
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          
      # 7. ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ë° ë°°í¬
      - name: Deploy to ECS service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE_NAME }}
          cluster: ${{ env.ECS_CLUSTER_NAME }}
          wait-for-service-stability: true